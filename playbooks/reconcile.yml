---
- name: Reconcile migrated server
  hosts: migrated
  become: true
  gather_facts: true
  vars_files:
    - ../host_vars/migrated.yml
    - ../host_vars/migrated_secrets.yml
  pre_tasks:
    - name: Update apt cache (best effort, ignore third-party repo errors)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_update_result
      failed_when: false
      changed_when: false

    - name: Warn if apt cache update had issues
      debug:
        msg: "Apt cache update had warnings (likely third-party repos) but continuing"
      when: apt_update_result is failed

    - name: Detect PHP version for this Debian release
      set_fact:
        php_version: "{{ '8.4' if ansible_distribution_major_version | int >= 13 else '8.2' }}"

    - name: Set PHP-derived variables
      set_fact:
        php_fpm_package: "php{{ php_version }}-fpm"
        php_fpm_mysql_package: "php{{ php_version }}-mysql"
        php_fpm_service: "php{{ php_version }}-fpm"
        php_fpm_conf_dir: "/etc/php/{{ php_version }}/fpm"
        php_fpm_conf_file: "/etc/php/{{ php_version }}/fpm/php-fpm.conf"
        php_fpm_pool_file: "/etc/php/{{ php_version }}/fpm/pool.d/www.conf"
        php_fpm_sock: "/run/php/php{{ php_version }}-fpm.sock"
        php_fpm_pid: "/run/php/php{{ php_version }}-fpm.pid"

    - name: Log detected versions
      debug:
        msg: "Debian {{ ansible_distribution_major_version }} detected â€” using PHP {{ php_version }}"

  tasks:
    - name: Include roles with ignore_errors
      include_role:
        name: "{{ item }}"
      loop:
        - apt_repos
        - root_password
        - keyboard
        - dns
        - locale
        - ntp
        - aide
        - sudo
        - prometheus
        - alert_manager
        - grafana
        - entropy
        - certbot
        - logwatch
        - ansible_pull
        - swap
        - clean
        - hostname
        - cron
        - logrotate
        - passwd
        - fail2ban
        - fail2counter
        - clamav
        - chkrootkit
        - rsyslog
        - motd
        - node_exporter
        - opendkim
        - opendmarc
        - postsrsd
        - spamassassin
        - apt
        - iptables
        - vnc
        - jumphost
        - kernel
        - auditd
        - apparmor
        - wayland
        - grub
        - sshd
        - pam
        - network_manager
        - mysql
        - memcached
        - redis
        - php_fpm
        - postfix
        - apache2
        - services
        - chuckbot
        - rclone
        - saslauthd
      when: role_to_run is not defined or role_to_run == item
      ignore_errors: true
