---
- name: Read existing GRUB_CMDLINE_LINUX line
  slurp:
    src: /etc/default/grub
  register: grub_file

- name: Extract GRUB_CMDLINE_LINUX value
  set_fact:
    grub_cmdline: >-
      {{
        (grub_file.content | b64decode)
        | regex_search('^GRUB_CMDLINE_LINUX="(.*)"', '\\1', multiline=True)
        | default('')
      }}

- name: Build updated GRUB_CMDLINE_LINUX with tty0 and without ttyS0
  set_fact:
    updated_cmdline: >-
      {{
        (
          (grub_cmdline.split() | difference(['console=ttyS0', 'console=ttyS0,115200']) | union(['console=tty0']))
          | unique
        ) | join(' ')
      }}

- name: Update GRUB_CMDLINE_LINUX in /etc/default/grub
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX='
    line: 'GRUB_CMDLINE_LINUX="{{ updated_cmdline }}"'
    backup: yes

- name: Run update-grub to apply changes
  command: update-grub
