---
# --- System packages ---

- name: Install required packages
  apt:
    name:
      - gpgv2
      - autoconf
      - bison
      - build-essential
      - postgresql
      - libaprutil1
      - libgmp3-dev
      - libpcap-dev
      - openssl
      - libpq-dev
      - libreadline-dev
      - libsqlite3-dev
      - libssl-dev
      - locate
      - libsvn1
      - libtool
      - libxml2
      - libxml2-dev
      - libxslt-dev
      - wget
      - libyaml-dev
      - ncurses-dev
      - postgresql-contrib
      - xsel
      - zlib1g
      - zlib1g-dev
      - curl
      - nmap
      - python3-pip
    state: present

- name: Install Python dependencies for AI integration
  pip:
    name:
      - "anthropic[vertex]"
      - psycopg2-binary
      - redis
    state: present
    executable: pip3
    break_system_packages: true

# --- Metasploit Framework ---

- name: Check if Metasploit is installed
  command: which msfconsole
  register: metasploit_check
  ignore_errors: true
  changed_when: false

- name: Download Metasploit install script
  get_url:
    url: https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb
    dest: /tmp/msfinstall
    mode: '0755'
  when: metasploit_check.rc != 0

- name: Run Metasploit install script
  command: /tmp/msfinstall
  when: metasploit_check.rc != 0

- name: Initialize Metasploit database
  command: msfdb init
  args:
    creates: /var/lib/postgresql/.msf_db_initialized
  register: msfdb_init
  failed_when: false

- name: Mark msfdb as initialized
  file:
    path: /var/lib/postgresql/.msf_db_initialized
    state: touch
    modification_time: preserve
    access_time: preserve
  when: msfdb_init is changed

- name: Check when Metasploit was last updated
  stat:
    path: /opt/metasploit-framework/.msf_last_update
  register: msf_last_update

- name: Update Metasploit modules (weekly)
  command: msfupdate
  when: >
    not msf_last_update.stat.exists or
    (ansible_date_time.epoch | int - msf_last_update.stat.mtime | default(0) | int) > 604800
  register: msf_update
  failed_when: false
  timeout: 600

- name: Mark Metasploit update timestamp
  file:
    path: /opt/metasploit-framework/.msf_last_update
    state: touch
  when: msf_update is changed

# --- Deploy fail2counter files ---

- name: Create script directory
  file:
    path: /opt/fail2counter
    state: directory
    mode: '0755'

- name: Deploy exploit list
  copy:
    src: exploits.txt
    dest: /opt/fail2counter/exploits.txt
    mode: '0644'

- name: Deploy detailed exploit options file
  copy:
    src: metasploit_exploits_with_options.txt
    dest: /opt/fail2counter/metasploit_exploits_with_options.txt
    mode: '0644'

- name: Deploy exploit list refresh script
  copy:
    src: refresh_exploits.sh
    dest: /opt/fail2counter/refresh_exploits.sh
    mode: '0755'

- name: Refresh exploit list from installed Metasploit (weekly)
  command: /opt/fail2counter/refresh_exploits.sh
  when: msf_update is changed
  failed_when: false
  timeout: 300

- name: Deploy AI module
  copy:
    src: ai.py
    dest: /opt/fail2counter/ai.py
    mode: '0644'

- name: Deploy database schema
  copy:
    src: schema.sql
    dest: /opt/fail2counter/schema.sql
    mode: '0644'

- name: Deploy schema migration script
  copy:
    src: migrate_schema.sql
    dest: /opt/fail2counter/migrate_schema.sql
    mode: '0644'

# --- PostgreSQL database setup (uses MSF's Postgres instance) ---

- name: Create fail2counter PostgreSQL user
  become: true
  become_user: postgres
  command: psql -c "DO $$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'fail2counter') THEN CREATE ROLE fail2counter WITH LOGIN; END IF; END $$;"
  changed_when: false
  failed_when: false

- name: Create fail2counter PostgreSQL database
  become: true
  become_user: postgres
  command: psql -c "SELECT 1 FROM pg_database WHERE datname = 'fail2counter'" -t
  register: pg_db_check
  changed_when: false

- name: Create fail2counter database if not exists
  become: true
  become_user: postgres
  command: createdb -O fail2counter fail2counter
  when: pg_db_check.stdout.strip() != '1'

- name: Grant fail2counter user access
  become: true
  become_user: postgres
  command: psql -c "GRANT ALL PRIVILEGES ON DATABASE fail2counter TO fail2counter;"
  changed_when: false
  failed_when: false

- name: Run schema migration (rename old exploits table if needed)
  become: true
  become_user: postgres
  command: psql -d fail2counter -f /opt/fail2counter/migrate_schema.sql
  changed_when: false
  failed_when: false

- name: Initialize fail2counter database schema
  become: true
  become_user: postgres
  command: psql -d fail2counter -f /opt/fail2counter/schema.sql
  changed_when: false
  failed_when: false

- name: Grant fail2counter ownership on all tables
  become: true
  become_user: postgres
  shell: |
    psql -d fail2counter -c "GRANT ALL ON ALL TABLES IN SCHEMA public TO fail2counter;"
    psql -d fail2counter -c "GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO fail2counter;"
  changed_when: false
  failed_when: false

# --- VPN network namespace ---

- name: Install OpenVPN
  apt:
    name: openvpn
    state: present

- name: Deploy VPN namespace management script
  copy:
    src: vpn_namespace.sh
    dest: /opt/fail2counter/vpn_namespace.sh
    mode: '0755'

- name: Deploy VPN configuration
  copy:
    content: "{{ fail2counter_vpn_config }}"
    dest: /opt/fail2counter/vpn.ovpn
    owner: root
    group: root
    mode: '0600'
  when: fail2counter_vpn_config is defined
  no_log: true

- name: Deploy VPN namespace systemd service
  template:
    src: "fail2counter-vpn.service.j2"
    dest: "/etc/systemd/system/fail2counter-vpn.service"
    owner: "root"
    group: "root"
    mode: '0644'

- name: Enable and start VPN namespace service
  systemd:
    daemon_reload: true
    name: fail2counter-vpn
    enabled: true
    state: started

# --- Deploy scripts and service ---

- name: Deploy push script
  template:
    src: "fail2counter_push_ip.py.j2"
    dest: "/opt/fail2counter/fail2counter_push_ip.py"
    owner: "root"
    group: "root"
    mode: '0755'

- name: Deploy worker script
  copy:
    src: fail2counter_worker.py
    dest: /opt/fail2counter/fail2counter_worker.py
    mode: '0755'

- name: Deploy query script
  copy:
    src: 1.query.py
    dest: /opt/fail2counter/1.query.py
    mode: '0755'

- name: Deploy GCP service account credentials
  copy:
    src: "{{ gcp_sa_key_file }}"
    dest: /opt/fail2counter/gcp-sa-key.json
    owner: root
    group: root
    mode: '0600'
  when: gcp_sa_key_file is defined

- name: Deploy systemd service
  template:
    src: "fail2counter.service.j2"
    dest: "/etc/systemd/system/fail2counter.service"
    owner: "root"
    group: "root"
    mode: '0644'

- name: Reload systemd and enable service
  systemd:
    daemon_reload: true
    name: fail2counter
    enabled: true
    state: restarted

- name: Configure Fail2Ban custom action
  copy:
    src: redis-queue.conf
    dest: /etc/fail2ban/action.d/redis-queue.conf
    mode: '0644'

# --- Cron for weekly exploit refresh ---

- name: Schedule weekly exploit list refresh
  cron:
    name: "fail2counter refresh exploits"
    job: "/opt/fail2counter/refresh_exploits.sh >> /var/log/fail2counter_refresh.log 2>&1"
    weekday: "0"
    hour: "3"
    minute: "0"
    user: root
