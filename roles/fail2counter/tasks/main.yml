---

- name: Create script directory
  file:
    path: /opt/fail2counter
    state: directory
    mode: '0755'

- name: Deploy exploit list
  copy:
    src: exploits.txt
    dest: /opt/fail2counter/exploits.txt
    mode: '0644'

- name: Deploy push script
  copy:
    src: fail2counter_push_ip.py
    dest: /opt/fail2counter/fail2counter_push_ip.py
    mode: '0755'

- name: Deploy worker script
  copy:
    src: fail2counter_worker.py
    dest: /opt/fail2counter/fail2counter_worker.py
    mode: '0755'

- name: Deploy systemd service
  template:
    src: "fail2counter.service.j2"
    dest: "/etc/systemd/system/fail2counter.service"
    owner: "root"
    group: "root"
    mode: '0644'

- name: Reload systemd and enable service
  systemd:
    daemon_reload: yes
    name: fail2counter
    enabled: yes
    state: started

- name: Configure Fail2Ban custom action
  copy:
    src: redis-queue.conf
    dest: /etc/fail2ban/action.d/redis-queue.conf
    mode: '0644'
