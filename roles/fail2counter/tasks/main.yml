---
- name: Install required packages
  apt:
    name:
      - gpgv2
      - autoconf
      - bison
      - build-essential
      - postgresql
      - libaprutil1
      - libgmp3-dev
      - libpcap-dev
      - openssl
      - libpq-dev
      - libreadline-dev
      - libsqlite3-dev
      - libssl-dev
      - locate
      - libsvn1
      - libtool
      - libxml2
      - libxml2-dev
      - libxslt-dev
      - wget
      - libyaml-dev
      - ncurses-dev
      - postgresql-contrib
      - xsel
      - zlib1g
      - zlib1g-dev
      - curl
      - nmap
      - python3-pip
    state: present

- name: Check if Metasploit is installed
  command: which msfconsole
  register: metasploit_check
  ignore_errors: true
  changed_when: false

- name: Download Metasploit install script
  get_url:
    url: https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb
    dest: /tmp/msfinstall
    mode: '0755'
  when: metasploit_check.rc != 0

- name: Run Metasploit install script
  command: /tmp/msfinstall
  when: metasploit_check.rc != 0

- name: Install Python dependencies for AI integration
  pip:
    name:
      - "anthropic[vertex]"
      - mysql-connector-python
      - redis
      - PyMySQL
    state: present
    executable: pip3
    break_system_packages: true

- name: Create script directory
  file:
    path: /opt/fail2counter
    state: directory
    mode: '0755'

- name: Deploy exploit list
  copy:
    src: exploits.txt
    dest: /opt/fail2counter/exploits.txt
    mode: '0644'

- name: Deploy detailed exploit options file
  copy:
    src: metasploit_exploits_with_options.txt
    dest: /opt/fail2counter/metasploit_exploits_with_options.txt
    mode: '0644'

- name: Deploy AI module
  copy:
    src: ai.py
    dest: /opt/fail2counter/ai.py
    mode: '0644'

- name: Deploy database schema
  copy:
    src: schema.sql
    dest: /opt/fail2counter/schema.sql
    mode: '0644'

- name: Deploy schema migration script
  copy:
    src: migrate_schema.sql
    dest: /opt/fail2counter/migrate_schema.sql
    mode: '0644'

- name: Run schema migration (rename old exploits table if needed)
  shell: mysql fail2counter < /opt/fail2counter/migrate_schema.sql
  changed_when: false
  failed_when: false

- name: Create fail2counter MySQL database
  community.mysql.mysql_db:
    name: fail2counter
    state: present
    login_unix_socket: /run/mysqld/mysqld.sock
    check_implicit_admin: yes
  failed_when: false

- name: Create fail2counter MySQL user
  community.mysql.mysql_user:
    name: fail2counter
    password: "{{ FAIL2COUNTER_PASSWORD }}"
    priv: "fail2counter.*:ALL"
    state: present
    login_unix_socket: /run/mysqld/mysqld.sock
    check_implicit_admin: yes
  failed_when: false

- name: Initialize fail2counter database schema
  community.mysql.mysql_db:
    name: fail2counter
    state: import
    target: /opt/fail2counter/schema.sql
    login_unix_socket: /run/mysqld/mysqld.sock
    check_implicit_admin: yes
  register: schema_import
  failed_when: false
  changed_when: schema_import.rc | default(0) == 0

- name: Deploy push script
  template:
    src: "fail2counter_push_ip.py.j2"
    dest: "/opt/fail2counter/fail2counter_push_ip.py"
    owner: "root"
    group: "root"
    mode: '0755'

- name: Deploy worker script
  copy:
    src: fail2counter_worker.py
    dest: /opt/fail2counter/fail2counter_worker.py
    mode: '0755'

- name: Deploy GCP service account credentials
  copy:
    src: "{{ gcp_sa_key_file }}"
    dest: /opt/fail2counter/gcp-sa-key.json
    owner: root
    group: root
    mode: '0600'
  when: gcp_sa_key_file is defined

- name: Deploy systemd service
  template:
    src: "fail2counter.service.j2"
    dest: "/etc/systemd/system/fail2counter.service"
    owner: "root"
    group: "root"
    mode: '0644'

- name: Reload systemd and enable service
  systemd:
    daemon_reload: true
    name: fail2counter
    enabled: true
    state: started

- name: Configure Fail2Ban custom action
  copy:
    src: redis-queue.conf
    dest: /etc/fail2ban/action.d/redis-queue.conf
    mode: '0644'
