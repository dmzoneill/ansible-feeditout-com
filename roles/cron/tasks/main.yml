---
- name: Ensure cron is installed
  apt:
    name: cron
    state: present
    update_cache: true

- name: Check if crontab files need updating (dry-run)
  copy:
    src: "files/{{ cron.src }}"
    dest: "/var/spool/cron/crontabs/{{ cron.user }}"
    owner: "{{ cron.user }}"
    group: crontab
    mode: '0600'
  loop: "{{ cron_user_files }}"
  loop_control:
    loop_var: cron
  check_mode: true
  register: cron_copy_check
  changed_when: false

- name: Determine if any crontab file would change
  set_fact:
    cron_needs_update: true
  when: >
    cron_copy_check.results is defined and
    cron_copy_check.results
    | selectattr('changed', 'defined')
    | selectattr('changed')
    | list | length > 0

- name: Stop cron before copying crontabs (only if needed)
  systemd:
    name: cron
    state: stopped
    enabled: true
  when: cron_needs_update | default(false)

- name: Copy crontab files for users (actual write)
  copy:
    src: "files/{{ cron.src }}"
    dest: "/var/spool/cron/crontabs/{{ cron.user }}"
    owner: "{{ cron.user }}"
    group: crontab
    mode: '0600'
  loop: "{{ cron_user_files }}"
  loop_control:
    loop_var: cron
  when: cron_needs_update | default(false)
  notify: Start and enable cron
