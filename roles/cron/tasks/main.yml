---
- name: Ensure cron is installed
  apt:
    name: cron
    state: present
    update_cache: true

- name: Check if crontab files are missing
  stat:
    path: "/var/spool/cron/crontabs/{{ cron.user }}"
  loop: "{{ cron_user_files }}"
  loop_control:
    loop_var: cron
  register: cron_stat

- name: Determine if any crontab file is missing
  set_fact:
    cron_needs_update: true
  when: >
    cron_stat.results
    | selectattr('stat.exists', 'equalto', false)
    | list | length > 0

- name: Stop cron before copying crontabs (only if needed)
  systemd:
    name: cron
    state: stopped
    enabled: true
  when: cron_needs_update | default(false)

- name: Copy crontab files for users (actual write)
  copy:
    src: "files/{{ cron.src }}"
    dest: "/var/spool/cron/crontabs/{{ cron.user }}"
    owner: "{{ cron.user }}"
    group: crontab
    mode: '0600'
  loop: "{{ cron_user_files }}"
  loop_control:
    loop_var: cron
  when: cron_needs_update | default(false)
  notify: Start and enable cron
