---
- name: Ensure NetworkManager is installed
  apt:
    name: network-manager
    state: present
    update_cache: yes

- name: Enable and start NetworkManager
  systemd:
    name: NetworkManager
    enabled: yes
    state: started

- name: Ensure [main] section exists in NetworkManager.conf
  blockinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    block: |
      [main]
      dns=none
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DO NOT EDIT"
  notify: Restart NetworkManager

- name: Remove iface lines from /etc/network/interfaces (if any)
  lineinfile:
    path: /etc/network/interfaces
    regexp: '^iface .* inet'
    state: absent
  notify: Restart NetworkManager
  when: ansible_facts['distribution'] == 'Debian'

- name: Enable autoconnect for all NetworkManager connections
  shell: |
    nmcli -t -f NAME con show | while read line; do
      nmcli con modify "$line" connection.autoconnect yes
    done
  changed_when: false

- name: Restart NetworkManager
  systemd:
    name: NetworkManager
    state: restarted
  when: NetworkManager_restart_required is not defined or NetworkManager_restart_required
  listen: Restart NetworkManager
