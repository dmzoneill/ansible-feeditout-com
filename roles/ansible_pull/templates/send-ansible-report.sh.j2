#!/bin/bash
LOG="/var/log/ansible-pull.log"
TMP="/tmp/ansible-mail.$$.txt"
TO="{{ email }}"

# Make a clean, static copy of the log
cp "$LOG" "$TMP"

# Strip trailing blank lines and whitespace
sed -i '/^[[:space:]]*$/d' "$TMP"

# Remove non-ASCII chars just in case
iconv -f utf-8 -t ascii//TRANSLIT "$TMP" -o "$TMP.cleaned"

# Send the email with fixed body
/usr/bin/mail \
  -a "Content-Type: text/plain; charset=us-ascii" \
  -a "Content-Transfer-Encoding: 7bit" \
  -s "Ansible-pull report from $(hostname)" "$TO" < "$TMP.cleaned"

# Clean up and truncate
rm -f "$TMP" "$TMP.cleaned"
truncate -s 0 "$LOG"
