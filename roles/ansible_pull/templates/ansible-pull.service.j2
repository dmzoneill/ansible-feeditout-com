[Unit]
Description=Run ansible-pull from Git repository
After=network.target

[Service]
Type=oneshot
WorkingDirectory={{ ansible_pull_workdir }}
Environment="ANSIBLE_CALLBACK_WHITELIST=profile_tasks"
Environment="ANSIBLE_CONFIG={{ ansible_pull_workdir }}/ansible.cfg"
ExecStart=/bin/bash -c "/usr/bin/ansible-pull \
  -i {{ ansible_pull_workdir }}/inventories/hosts_local.ini \
  -U {{ ansible_pull_repo_url }} \
  -d {{ ansible_pull_workdir }} \
  --vault-password-file=/etc/ansible/.vault_pass.txt \
  playbooks/reconcile.yml > /var/log/ansible-pull.log 2>&1"
ExecStartPost=/bin/bash -c "mail -s 'Ansible-pull report from $(hostname)' dmz.oneill@gmail.com < /var/log/ansible-pull.log"
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
