<VirtualHost *:443>
  ServerName {{ domain }}
  ServerAlias {{ domain_alias | default(domain) }}
  DocumentRoot /home/{{ role_user }}/www/{{ document_root }}
  LogLevel {{ loglevel }}
  CustomLog /var/log/apache2/{{ domain_alias }}-access.log combined
  ErrorLog /var/log/apache2/{{ domain_alias }}-error.log

  SSLEngine on
  RewriteEngine On

  <IfModule mpm_itk_module>
    AssignUserId {{ role_user }} {{ role_user }}
  </IfModule>
  
  <Directory />
    Options +FollowSymLinks +Includes +ExecCGI
    AllowOverride All
    Require all granted
  </Directory>

{{ lookup('template', vhost.domain + '.conf.j2', convert_data=False, vars={
  'domain': vhost.domain,
  'domain_alias': vhost.domain_alias,
  'document_root': vhost.document_root,
  'loglevel': vhost.loglevel,
  'role_user': vhost.role_user,
  'custom_directory_perms': vhost.custom_directory_perms
}) }}

  Include /etc/letsencrypt/options-ssl-apache.conf

  SSLCertificateFile /etc/letsencrypt/live/{{ domain }}/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/{{ domain }}/privkey.pem
  SSLCertificateChainFile /etc/letsencrypt/live/{{ domain }}/fullchain.pem

  Header always set Content-Security-Policy "upgrade-insecure-requests"
</VirtualHost>
