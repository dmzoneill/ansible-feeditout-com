#!/bin/bash
set -euo pipefail

SRC_PATHS="/etc /opt /root /home /usr/local /srv /var/log /boot /var/lib/mysql"
BACKUP_ROOT="/tmp/mysql-backup"
MYSQL_DUMP_FILE="$BACKUP_ROOT/backup.sql"
DEST="google-backup:server-backup-$(hostname)"
DATE=$(date +"%Y-%m-%d")
LOGFILE="/var/log/rclone-backup.log"
MYSQL_PASS="{{ mysql_root }}"

# Dump MySQL
mkdir -p "$BACKUP_ROOT"
mysqldump --all-databases -u root -p"$MYSQL_PASS" > "$MYSQL_DUMP_FILE"

# Sync each source path individually
for path in $SRC_PATHS; do
  echo "Syncing $path to $DEST/$DATE/system${path}" | tee -a "$LOGFILE"
  rclone sync "$path" "$DEST/$DATE/system${path}" \
    --log-level INFO \
    --log-file="$LOGFILE" \
    --delete-during \
    --transfers=8 \
    --checkers=8 \
    --bwlimit 500M
done

# Copy MySQL dump separately
echo "Copying MySQL dump to $DEST/$DATE/mysqldump" | tee -a "$LOGFILE"
rclone copy "$BACKUP_ROOT" "$DEST/$DATE/mysqldump" \
  --log-level INFO \
  --log-file="$LOGFILE"

# Retention: keep only the most recent 7 backups
echo "Applying retention policy (keep 7 latest backups)" | tee -a "$LOGFILE"
rclone lsf "$DEST" --dirs-only | sort | head -n -7 | while read -r olddir; do
  echo "Deleting old backup folder: $DEST/$olddir" | tee -a "$LOGFILE"
  rclone purge "$DEST/$olddir" \
    --log-level INFO \
    --log-file="$LOGFILE"
done

# Clean old CSRs (older than 7 days)
echo "Cleaning old CSR files from /etc/letsencrypt/csr/" | tee -a "$LOGFILE"
find /etc/letsencrypt/csr/ -type f -name '*.csr' -mtime +7 -print -delete >> "$LOGFILE"

# Cleanup
rm -rf "$BACKUP_ROOT"
